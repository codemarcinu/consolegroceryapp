import json
import os
import shutil
import glob
from datetime import datetime, timedelta
from typing import List, Optional, Dict, Any
from models import Produkt
from storage_manager import StorageManager
from llm_integration import sugeruj_kategorie, sugeruj_date_waznosci
from config import KONFIGURACJA, KATEGORIE

class ProductManager:
    """
    Klasa zarzƒÖdzajƒÖca operacjami na produktach.
    """
    
    def __init__(self, storage_manager: Optional[StorageManager] = None):
        """
        Inicjalizuje mened≈ºer produkt√≥w.
        
        Args:
            storage_manager: Opcjonalny mened≈ºer przechowywania danych
        """
        self.storage_manager = storage_manager or StorageManager()
    
    def dodaj_szybki_produkt(self, konfiguracja_llm: Dict[str, Any]) -> bool:
        """
        Umo≈ºliwia szybkie dodanie pojedynczego produktu.
        
        Args:
            konfiguracja_llm: Konfiguracja LLM
            
        Returns:
            bool: True je≈õli dodanie siƒô powiod≈Ço, False w przeciwnym razie
        """
        try:
            # Pobierz nazwƒô produktu
            nazwa = input("\nüè∑Ô∏è Podaj nazwƒô produktu: ").strip()
            if not nazwa:
                print("‚ùå Nazwa produktu nie mo≈ºe byƒá pusta!")
                return False
            
            # Sugeruj kategoriƒô
            if KONFIGURACJA["llm"]["enabled"] and konfiguracja_llm.get("auto_categorize", True):
                print("\nü§ñ AI analizuje produkt...")
                sugerowana_kategoria = sugeruj_kategorie(nazwa, konfiguracja_llm)
                print(f"ü§ñ AI sugeruje kategoriƒô: {sugerowana_kategoria}")
                
                potwierdz = input("Akceptujesz sugestiƒô? (Enter=tak, n=nie, k=zmie≈Ñ kategoriƒô): ").lower()
                
                if potwierdz == 'n':
                    print("‚è≠Ô∏è Pominiƒôto sugestiƒô AI")
                    kategoria = self._wybierz_kategorie_reczne()
                elif potwierdz == 'k':
                    kategoria = self._wybierz_kategorie_reczne()
                else:
                    kategoria = sugerowana_kategoria
            else:
                kategoria = self._wybierz_kategorie_reczne()
            
            # Sugeruj datƒô wa≈ºno≈õci
            if KONFIGURACJA["llm"]["enabled"] and konfiguracja_llm.get("auto_expiry_date", True):
                print("\nü§ñ AI sugeruje datƒô wa≈ºno≈õci...")
                sugerowana_data = sugeruj_date_waznosci(nazwa, kategoria, konfiguracja_llm)
                print(f"üóìÔ∏è AI sugeruje datƒô wa≈ºno≈õci: {sugerowana_data.strftime('%Y-%m-%d')}")
                
                data_input = input("Akceptujesz? (Enter=tak, lub podaj datƒô YYYY-MM-DD): ").strip()
                if data_input:
                    try:
                        data_waznosci = datetime.strptime(data_input, "%Y-%m-%d")
                        # Sprawd≈∫ czy data nie jest z przesz≈Ço≈õci
                        if data_waznosci.date() < datetime.now().date():
                            print("‚ö†Ô∏è Uwaga: Podana data jest z przesz≈Ço≈õci!")
                            potwierdz = input("Czy na pewno chcesz kontynuowaƒá? (t/n): ").lower()
                            if potwierdz != 't':
                                return False
                    except ValueError:
                        print("‚ùå B≈Çƒôdny format daty, u≈ºywam sugestii AI")
                        data_waznosci = sugerowana_data
                else:
                    data_waznosci = sugerowana_data
            else:
                data_waznosci = self._pobierz_date_waznosci()
            
            # Pobierz cenƒô (opcjonalnie)
            cena = self._pobierz_cene()
            
            # Utw√≥rz i zapisz produkt
            produkt = Produkt(
                nazwa=nazwa,
                kategoria=kategoria,
                data_waznosci=data_waznosci,
                cena=cena
            )
            
            return self.storage_manager.dodaj_produkt(produkt)
            
        except Exception as e:
            print(f"‚ùå B≈ÇƒÖd podczas dodawania produktu: {e}")
            return False
    
    def importuj_przetworzone_paragony(self, konfiguracja_llm: Dict[str, Any]) -> bool:
        """
        Importuje produkty z przetworzonych paragon√≥w do spi≈ºarni.
        
        Args:
            konfiguracja_llm: Konfiguracja LLM
            
        Returns:
            bool: True je≈õli import siƒô powi√≥d≈Ç, False w przeciwnym razie
        """
        try:
            # Znajd≈∫ wszystkie pliki JSON z przetworzonymi paragonami
            json_files = glob.glob(os.path.join(KONFIGURACJA["paths"]["dane_json_folder"], "paragon_*.json"))
            
            if not json_files:
                print("üìÅ Brak przetworzonych paragon√≥w do importu")
                return False
            
            print(f"üìã Znaleziono {len(json_files)} przetworzonych paragon√≥w:")
            
            # Wy≈õwietl listƒô paragon√≥w
            for i, json_file in enumerate(json_files, 1):
                try:
                    with open(json_file, 'r', encoding='utf-8') as f:
                        data = json.load(f)
                    
                    nazwa_pliku = data.get('plik_zrodlowy', 'nieznany')
                    liczba_produktow = len(data.get('produkty', []))
                    data_przetworzenia = data.get('data_przetworzenia', 'nieznana')
                    
                    print(f"{i}. {nazwa_pliku} - {liczba_produktow} produkt√≥w ({data_przetworzenia})")
                    
                except Exception as e:
                    print(f"{i}. ‚ùå B≈ÇƒÖd odczytu: {os.path.basename(json_file)}")
            
            print("\n0. Importuj wszystkie")
            print("99. Anuluj")
            
            try:
                wybor = input("\nWybierz paragon do importu (0-99): ")
                
                if wybor == "99":
                    return False
                elif wybor == "0":
                    # Importuj wszystkie
                    for json_file in json_files:
                        self._importuj_pojedynczy_paragon(json_file, konfiguracja_llm)
                    return True
                else:
                    idx = int(wybor) - 1
                    if 0 <= idx < len(json_files):
                        return self._importuj_pojedynczy_paragon(json_files[idx], konfiguracja_llm)
                    else:
                        print("‚ùå Nieprawid≈Çowy wyb√≥r")
                        return False
                        
            except ValueError:
                print("‚ùå Nieprawid≈Çowy wyb√≥r")
                return False
            
        except Exception as e:
            print(f"‚ùå B≈ÇƒÖd podczas importu paragon√≥w: {e}")
            return False
    
    def _importuj_pojedynczy_paragon(self, json_file: str, konfiguracja_llm: Dict[str, Any]) -> bool:
        """
        Importuje produkty z pojedynczego paragonu.
        
        Args:
            json_file: ≈öcie≈ºka do pliku JSON z paragonem
            konfiguracja_llm: Konfiguracja LLM
            
        Returns:
            bool: True je≈õli import siƒô powi√≥d≈Ç
        """
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            produkty_z_paragonu = data.get('produkty', [])
            if not produkty_z_paragonu:
                print(f"‚ö†Ô∏è Brak produkt√≥w w {os.path.basename(json_file)}")
                return False
            
            print(f"\nüì¶ Import produkt√≥w z {data.get('plik_zrodlowy', 'paragonu')}:")
            
            dodano = 0
            
            for produkt_data in produkty_z_paragonu:
                nazwa = produkt_data.get('nazwa', '').strip()
                cena = produkt_data.get('cena', 0.0)
                
                if not nazwa:
                    continue
                    
                print(f"\nüè∑Ô∏è Produkt: {nazwa} ({cena:.2f} z≈Ç)")
                
                # AI sugeruje kategoriƒô
                if KONFIGURACJA["llm"]["enabled"] and konfiguracja_llm.get("auto_categorize", True):
                    kategoria = sugeruj_kategorie(nazwa, konfiguracja_llm)
                    print(f"ü§ñ AI sugeruje kategoriƒô: {kategoria}")
                    
                    potwierdz = input("Akceptujesz? (Enter=tak, n=nie, k=zmie≈Ñ kategoriƒô): ").lower()
                    
                    if potwierdz == 'n':
                        print("‚è≠Ô∏è Pominiƒôto produkt")
                        continue
                    elif potwierdz == 'k':
                        kategoria = self._wybierz_kategorie_reczne()
                else:
                    kategoria = self._wybierz_kategorie_reczne()
                
                # AI sugeruje datƒô wa≈ºno≈õci
                if KONFIGURACJA["llm"]["enabled"] and konfiguracja_llm.get("auto_expiry_date", True):
                    data_waznosci = sugeruj_date_waznosci(nazwa, kategoria, konfiguracja_llm)
                    print(f"üóìÔ∏è AI sugeruje datƒô wa≈ºno≈õci: {data_waznosci.strftime('%Y-%m-%d')}")
                    
                    data_input = input("Akceptujesz? (Enter=tak, lub podaj datƒô YYYY-MM-DD): ").strip()
                    if data_input:
                        try:
                            data_waznosci = datetime.strptime(data_input, "%Y-%m-%d")
                        except ValueError:
                            print("‚ùå B≈Çƒôdny format, u≈ºywam sugestii AI")
                else:
                    data_waznosci = self._pobierz_date_waznosci()
                
                # Dodaj produkt do spi≈ºarni
                nowy_produkt = Produkt(
                    nazwa=nazwa,
                    kategoria=kategoria,
                    data_waznosci=data_waznosci,
                    cena=cena,
                    data_dodania=datetime.now(),
                    zuzyty=False,
                    id_paragonu=os.path.basename(json_file)
                )
                
                if self.storage_manager.dodaj_produkt(nowy_produkt):
                    dodano += 1
                    print(f"‚úÖ Dodano: {nazwa}")
                else:
                    print(f"‚ùå B≈ÇƒÖd podczas dodawania: {nazwa}")
            
            if dodano > 0:
                print(f"\nüéâ Zaimportowano {dodano} produkt√≥w!")
                
                # Przenie≈õ przetworzony plik do archiwum
                os.makedirs(KONFIGURACJA["paths"]["archiwum_json"], exist_ok=True)
                archive_file = os.path.join(KONFIGURACJA["paths"]["archiwum_json"], os.path.basename(json_file))
                shutil.move(json_file, archive_file)
                print(f"üìÅ Paragon przeniesiony do archiwum")
                
                return True
            else:
                print("‚ùå Nie dodano ≈ºadnych produkt√≥w")
                return False
                
        except Exception as e:
            print(f"‚ùå B≈ÇƒÖd importu: {e}")
            return False
    
    def szybkie_zarzadzanie_produktami(self) -> bool:
        """
        Umo≈ºliwia szybkie wyszukiwanie i zarzƒÖdzanie produktami.
        
        Returns:
            bool: True je≈õli operacja siƒô powiod≈Ça, False w przeciwnym razie
        """
        try:
            # Pobierz frazƒô wyszukiwania
            fraza = input("\nüîç Podaj frazƒô do wyszukania: ").strip()
            if not fraza:
                print("‚ùå Fraza wyszukiwania nie mo≈ºe byƒá pusta!")
                return False
            
            # Wczytaj produkty
            produkty = self.storage_manager.wczytaj_produkty()
            produkty_aktywne = [p for p in produkty if not p.zuzyty]
            
            if not produkty_aktywne:
                print("‚ùå Brak aktywnych produkt√≥w!")
                return False
            
            # Wyszukiwanie rozmyte
            try:
                from fuzzywuzzy import fuzz
                
                wyniki = []
                for i, produkt in enumerate(produkty_aktywne):
                    podobienstwo = fuzz.partial_ratio(fraza.lower(), produkt.nazwa.lower())
                    if podobienstwo > 60:  # 60% podobie≈Ñstwa
                        dni_do_konca = (produkt.data_waznosci - datetime.now()).days
                        wyniki.append((produkt, podobienstwo, dni_do_konca, i))
                
                if wyniki:
                    wyniki.sort(key=lambda x: (-x[1], x[2]))  # sortuj po podobie≈Ñstwie, potem po terminie
                    
                    print(f"\nüì¶ Znalezione produkty dla '{fraza}':")
                    for i, (produkt, podobienstwo, dni, _) in enumerate(wyniki[:5], 1):
                        kolor = "üî¥" if dni <= 3 else "üü°" if dni <= 7 else "üü¢"
                        print(f"{i}. {kolor} {produkt.nazwa} ({produkt.kategoria}) - ko≈Ñczy siƒô za {dni} dni")
                    
                    try:
                        wybor = input("\nWybierz numer produktu do zarzƒÖdzania (Enter = anuluj): ")
                        if wybor:
                            idx = int(wybor) - 1
                            if 0 <= idx < len(wyniki):
                                wybrany_produkt, _, _, original_idx = wyniki[idx]
                                return self._zarzadzaj_produktem(wybrany_produkt, produkty)
                    except (ValueError, IndexError):
                        print("‚ùå Nieprawid≈Çowy wyb√≥r")
                else:
                    print(f"‚ùå Nie znaleziono produkt√≥w dla '{fraza}'")
                    
            except ImportError:
                print("‚ö†Ô∏è Modu≈Ç fuzzywuzzy nie jest zainstalowany. U≈ºywanie prostego wyszukiwania...")
                # Proste wyszukiwanie bez fuzzywuzzy
                wyniki = [p for p in produkty_aktywne if fraza.lower() in p.nazwa.lower()]
                if wyniki:
                    print(f"\nüì¶ Znalezione produkty dla '{fraza}':")
                    for i, produkt in enumerate(wyniki[:5], 1):
                        dni_do_konca = (produkt.data_waznosci - datetime.now()).days
                        kolor = "üî¥" if dni_do_konca <= 3 else "üü°" if dni_do_konca <= 7 else "üü¢"
                        print(f"{i}. {kolor} {produkt.nazwa} ({produkt.kategoria}) - ko≈Ñczy siƒô za {dni_do_konca} dni")
                    
                    try:
                        wybor = input("\nWybierz numer produktu do zarzƒÖdzania (Enter = anuluj): ")
                        if wybor:
                            idx = int(wybor) - 1
                            if 0 <= idx < len(wyniki):
                                return self._zarzadzaj_produktem(wyniki[idx], produkty)
                    except (ValueError, IndexError):
                        print("‚ùå Nieprawid≈Çowy wyb√≥r")
                else:
                    print(f"‚ùå Nie znaleziono produkt√≥w dla '{fraza}'")
            
            return False
            
        except Exception as e:
            print(f"‚ùå B≈ÇƒÖd podczas zarzƒÖdzania produktami: {e}")
            return False
    
    def _zarzadzaj_produktem(self, produkt: Produkt, wszystkie_produkty: List[Produkt]) -> bool:
        """
        ZarzƒÖdza wybranym produktem.
        
        Args:
            produkt: Wybrany produkt
            wszystkie_produkty: Lista wszystkich produkt√≥w
            
        Returns:
            bool: True je≈õli operacja siƒô powiod≈Ça
        """
        print(f"\nüì¶ ZarzƒÖdzanie produktem: {produkt.nazwa}")
        print("1. Oznacz jako zu≈ºyty")
        print("2. Usu≈Ñ ca≈Çkowicie")
        print("3. Anuluj")
        
        while True:
            try:
                akcja = input("\nWybierz akcjƒô (1-3): ").strip()
                if akcja == "1":
                    indeks = wszystkie_produkty.index(produkt)
                    if self.storage_manager.oznacz_jako_zuzyty(indeks):
                        print(f"‚úÖ {produkt.nazwa} oznaczony jako zu≈ºyty!")
                        return True
                    else:
                        print("‚ùå B≈ÇƒÖd podczas oznaczania jako zu≈ºyty")
                        return False
                elif akcja == "2":
                    indeks = wszystkie_produkty.index(produkt)
                    if self.storage_manager.usun_produkt(indeks):
                        print(f"‚úÖ {produkt.nazwa} usuniƒôty ca≈Çkowicie!")
                        return True
                    else:
                        print("‚ùå B≈ÇƒÖd podczas usuwania")
                        return False
                elif akcja == "3":
                    return False
                else:
                    print("‚ùå Nieprawid≈Çowy wyb√≥r!")
            except ValueError:
                print("‚ùå Nieprawid≈Çowy wyb√≥r!")
    
    def _wybierz_kategorie_reczne(self) -> str:
        """
        Pozwala u≈ºytkownikowi wybraƒá kategoriƒô rƒôcznie.
        
        Returns:
            str: Wybrana kategoria
        """
        print("\nDostƒôpne kategorie:")
        for i, kat in enumerate(KATEGORIE, 1):
            print(f"{i}. {kat}")
        
        while True:
            try:
                wybor = input(f"\nWybierz kategoriƒô (1-{len(KATEGORIE)}): ").strip()
                if wybor.isdigit() and 1 <= int(wybor) <= len(KATEGORIE):
                    return KATEGORIE[int(wybor) - 1]
                else:
                    print("‚ùå Nieprawid≈Çowy wyb√≥r!")
            except ValueError:
                print("‚ùå Nieprawid≈Çowy wyb√≥r!")
    
    def _pobierz_date_waznosci(self) -> datetime:
        """
        Pobiera datƒô wa≈ºno≈õci od u≈ºytkownika.
        
        Returns:
            datetime: Data wa≈ºno≈õci
        """
        while True:
            try:
                data_str = input("\nPodaj datƒô wa≈ºno≈õci (YYYY-MM-DD): ").strip()
                data = datetime.strptime(data_str, "%Y-%m-%d")
                
                if data.date() < datetime.now().date():
                    print("‚ö†Ô∏è Uwaga: Podana data jest z przesz≈Ço≈õci!")
                    potwierdz = input("Czy na pewno chcesz kontynuowaƒá? (t/n): ")
                    if potwierdz.lower() != 't':
                        continue
                
                return data
            except ValueError:
                print("‚ùå B≈Çƒôdny format daty! U≈ºyj formatu YYYY-MM-DD")
    
    def _pobierz_cene(self) -> Optional[float]:
        """
        Pobiera cenƒô produktu od u≈ºytkownika.
        
        Returns:
            Optional[float]: Cena produktu lub None
        """
        while True:
            cena_str = input("\nüí∞ Podaj cenƒô (opcjonalnie, Enter aby pominƒÖƒá): ").strip()
            if not cena_str:
                return None
            try:
                cena = float(cena_str.replace(',', '.'))
                if cena < 0:
                    print("‚ùå Cena nie mo≈ºe byƒá ujemna!")
                    continue
                return cena
            except ValueError:
                print("‚ùå Nieprawid≈Çowy format ceny!")